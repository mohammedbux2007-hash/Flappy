<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy+ Realistic</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      touch-action:manipulation;
    }
    #gameWrap{
      position:relative;
      width:100vw;
      height:100vh;
      max-width:480px;
      max-height:900px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{
      display:block;
      border-radius:18px;
      background:#111827;
      box-shadow:0 20px 45px rgba(0,0,0,0.35);
    }
    .top-ui{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:8px;
      z-index:10;
    }
    .btn{
      width:38px;
      height:38px;
      border-radius:12px;
      background:rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.08);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter:blur(4px);
      user-select:none;
    }
    .btn:active{transform:scale(0.94);}
  </style>
</head>
<body>
  <div id="gameWrap">
    <canvas id="game"></canvas>
    <div class="top-ui">
      <div class="btn" id="pauseBtn">II</div>
      <div class="btn" id="muteBtn">üîä</div>
    </div>
  </div>

  <!-- REAL MUSIC: put real audio links here -->
  <!-- make sure CORS allows it OR host on your own github/pages -->
  <audio id="bgm" loop preload="auto"></audio>

  <script>
  // ===== CONFIG FOR REAL ASSETS =====
  // put your real image URLs here
  const ASSETS = {
    // background images
    skyBg: "https://images.unsplash.com/photo-1508261306211-45a1c5c2a5c5?auto=format&fit=crop&w=800&q=60",
    seaBg: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=60",
    dinoBg: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=800&q=60", // jungly
    // pipes
    pipe: "",          // leave blank ‚Üí draw vector
    bonePipe: "",      // leave blank ‚Üí draw vector bones
    coralPipe: "",     // leave blank ‚Üí draw vector coral
    // characters
    bird: "",          // if empty ‚Üí draw vector cute bird
    fish: "",
    dino: "",
    plane: "",
    ghost: "",
    skeleton: ""
  };

  // REAL MUSIC URLS
  // replace with actual .mp3/.m4a hosted somewhere you control
  const MUSIC_URLS = {
    sky: "YOUR_SKY_MUSIC_URL_HERE",           // e.g. yoursite.com/audio/happy.mp3
    sea: "YOUR_SEA_MUSIC_URL_HERE",           // e.g. yoursite.com/audio/undersea.mp3
    jurassic: "YOUR_JURASSIC_MUSIC_URL_HERE"  // e.g. yoursite.com/audio/jungle.mp3
  };

  // ===== BASIC SETUP =====
  const BASE_W = 360;
  const BASE_H = 540;
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  canvas.width = BASE_W;
  canvas.height = BASE_H;

  function fitCanvas(){
    const wrap = document.getElementById("gameWrap");
    const w = wrap.clientWidth;
    const h = wrap.clientHeight;
    const scale = Math.min(w/BASE_W, h/BASE_H);
    canvas.style.width = BASE_W*scale+"px";
    canvas.style.height = BASE_H*scale+"px";
  }
  window.addEventListener("resize", fitCanvas);
  fitCanvas();

  // ===== GAME STATE =====
  let gameState = "home";
  const GRAVITY = 0.29;
  const FLAP = -6.5;
  const PIPE_WIDTH = 64;
  const PIPE_INTERVAL = 1550;
  const FLOOR_HEIGHT = 76;
  const HITBOX_SHRINK = 0.7;

  // difficulty scaler
  function getDifficulty(score){
    const s = Math.min(score, 30);
    const speed = 1.35 + s*0.03;   // start a bit easier than before
    const gap = 190 - s*1.2;       // wider start ‚Üí then tighter
    return {
      speed: Math.min(speed, 2.35),
      gap: Math.max(gap, 130)
    };
  }

  // SKINS
  const SKINS = [
    { id:"bird", name:"Classic Bird", price:0, unlockMeters:0 },
    { id:"skeleton", name:"Skeleton Bird", price:100, unlockMeters:0 },
    { id:"ghost", name:"Ghost", price:250, unlockMeters:0 },
    { id:"plane", name:"Aeroplane", price:0, unlockMeters:500 },
    { id:"fish", name:"Fish", price:200, unlockMeters:0 },
    { id:"dino", name:"Pterodactyl", price:300, unlockMeters:0 }
  ];
  let activeSkin = "bird";
  let ownedSkins = { bird:true };
  let maxMetersReached = 0;

  let bird, pipes, lastPipeTime, score, best=0, groundOffset=0;
  let coins = [];
  let totalCoins = 0;
  let particles = [];

  // backgrounds (images)
  const imgSkyBg = new Image(); if (ASSETS.skyBg) imgSkyBg.src = ASSETS.skyBg;
  const imgSeaBg = new Image(); if (ASSETS.seaBg) imgSeaBg.src = ASSETS.seaBg;
  const imgDinoBg = new Image(); if (ASSETS.dinoBg) imgDinoBg.src = ASSETS.dinoBg;
  const imgPipe = new Image(); if (ASSETS.pipe) imgPipe.src = ASSETS.pipe;
  const imgBonePipe = new Image(); if (ASSETS.bonePipe) imgBonePipe.src = ASSETS.bonePipe;
  const imgCoralPipe = new Image(); if (ASSETS.coralPipe) imgCoralPipe.src = ASSETS.coralPipe;
  const imgBird = new Image(); if (ASSETS.bird) imgBird.src = ASSETS.bird;
  const imgFish = new Image(); if (ASSETS.fish) imgFish.src = ASSETS.fish;
  const imgDino = new Image(); if (ASSETS.dino) imgDino.src = ASSETS.dino;
  const imgPlane = new Image(); if (ASSETS.plane) imgPlane.src = ASSETS.plane;
  const imgGhost = new Image(); if (ASSETS.ghost) imgGhost.src = ASSETS.ghost;
  const imgSkeleton = new Image(); if (ASSETS.skeleton) imgSkeleton.src = ASSETS.skeleton;

  // special env
  let bubbles = [];
  let seaCreatures = [];
  let smokePlumes = [];
  let bgDinos = [];
  let bgClouds = [];

  // UI
  const homeButtons = {
    play: { x:90, y:220, w:180, h:50 },
    store: { x:130, y:284, w:100, h:38 }
  };

  // music
  const bgm = document.getElementById("bgm");
  let muted = false;
  let musicMode = "sky"; // "sky" | "sea" | "jurassic"

  // load from storage
  try{
    const sc = localStorage.getItem("flappyCoins");
    if (sc) totalCoins = parseInt(sc,10)||0;
    const sb = localStorage.getItem("flappyBest");
    if (sb) best = parseInt(sb,10)||0;
    const so = localStorage.getItem("flappyOwnedSkins");
    if (so) ownedSkins = JSON.parse(so);
    const sa = localStorage.getItem("flappyActiveSkin");
    if (sa) activeSkin = sa;
    const sm = localStorage.getItem("flappyMaxMeters");
    if (sm) maxMetersReached = parseInt(sm,10)||0;
    if (activeSkin === "fish") musicMode = "sea";
    else if (activeSkin === "dino") musicMode = "jurassic";
  }catch(e){}

  function saveProgress(){
    try{
      localStorage.setItem("flappyCoins", totalCoins);
      localStorage.setItem("flappyBest", best);
      localStorage.setItem("flappyOwnedSkins", JSON.stringify(ownedSkins));
      localStorage.setItem("flappyActiveSkin", activeSkin);
      localStorage.setItem("flappyMaxMeters", maxMetersReached);
    }catch(e){}
  }

  function initClouds(){
    bgClouds = [];
    for (let i=0;i<6;i++){
      bgClouds.push({
        x:Math.random()*BASE_W,
        y:Math.random()*160+20,
        w:Math.random()*60+40,
        h:Math.random()*18+10,
        s:Math.random()*0.5+0.15
      });
    }
  }
  function initSea(){
    bubbles=[]; seaCreatures=[];
    for (let i=0;i<10;i++){
      bubbles.push({
        x:Math.random()*BASE_W,
        y:Math.random()*BASE_H,
        r:Math.random()*4+2,
        s:Math.random()*0.3+0.15
      });
    }
    for (let i=0;i<4;i++){
      seaCreatures.push({
        x:Math.random()*BASE_W,
        y:120+Math.random()*250,
        w:28+Math.random()*16,
        h:12+Math.random()*6,
        s:0.3+Math.random()*0.2,
        dir:Math.random()<0.5?1:-1,
        col:i%2===0?"rgba(255,255,255,0.35)":"rgba(248,250,252,0.22)"
      });
    }
  }
  function initJurassic(){
    smokePlumes=[];
    bgDinos=[];
    for (let i=0;i<6;i++){
      smokePlumes.push({
        x:40+i*50,
        y:190+Math.random()*20,
        r:10+Math.random()*6,
        v:0.25+Math.random()*0.35,
        a:0.6
      });
    }
    for (let i=0;i<4;i++){
      bgDinos.push({
        x:Math.random()*BASE_W,
        y:BASE_H - FLOOR_HEIGHT - 28 - Math.random()*30,
        s:0.25+Math.random()*0.15,
        dir:Math.random()<0.5?1:-1,
        col:i%2===0?"rgba(148,163,184,0.4)":"rgba(203,213,225,0.35)"
      });
    }
  }

  function resetGame(full=true){
    bird = { x:78, y:BASE_H/2, vy:0, r:16, anim:0 };
    pipes = [];
    coins = [];
    particles = [];
    lastPipeTime = performance.now();
    score = 0;
    groundOffset = 0;

    if (activeSkin === "fish") initSea();
    else if (activeSkin === "dino") initJurassic();
    else initClouds();

    if (full) gameState = "home";
  }

  // MUSIC CONTROL
  function playMusicForMode(mode){
    if (muted) return;
    const url = mode==="sea" ? MUSIC_URLS.sea :
                mode==="jurassic" ? MUSIC_URLS.jurassic :
                MUSIC_URLS.sky;
    if (!url){ bgm.pause(); return; }
    if (bgm.src !== url){
      bgm.src = url;
      bgm.load();
    }
    bgm.volume = 0.7;
    bgm.play().catch(()=>{ /* autoplay block */ });
  }

  // INPUT
  canvas.addEventListener("mousedown", tapHandler);
  canvas.addEventListener("touchstart", (e)=>{
    e.preventDefault();
    tapHandler(e.touches?e.touches[0]:e);
  },{passive:false});

  function tapHandler(e){
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (BASE_W / rect.width);
    const my = (e.clientY - rect.top) * (BASE_H / rect.height);

    if (gameState === "home"){
      if (pointInRect(mx,my,homeButtons.play)){
        startPlaying();
        return;
      }
      if (pointInRect(mx,my,homeButtons.store)){
        gameState = "store";
        return;
      }
      return;
    }
    if (gameState === "store"){
      const backBtn = getStoreBackButton();
      if (pointInRect(mx,my,backBtn)){
        gameState = "home";
        return;
      }
      const storeRects = getStoreRects();
      for (const s of storeRects){
        if (pointInRect(mx,my,s.rect)){
          onStoreSelect(s.skin);
          return;
        }
      }
      return;
    }

    flap();
  }

  document.addEventListener("keydown",(e)=>{
    if (e.code==="Space"||e.code==="ArrowUp") flap();
    if (e.code==="KeyP") togglePause();
    if (e.code==="KeyM") toggleMute();
    if (e.code==="Escape"&&gameState==="store") gameState="home";
  });

  const pauseBtn = document.getElementById("pauseBtn");
  const muteBtn = document.getElementById("muteBtn");
  pauseBtn.addEventListener("click", ()=>togglePause());
  muteBtn.addEventListener("click", ()=>toggleMute());

  function startPlaying(){
    gameState = "playing";
    // start music according to skin
    if (activeSkin==="fish") musicMode = "sea";
    else if (activeSkin==="dino") musicMode = "jurassic";
    else musicMode = "sky";
    playMusicForMode(musicMode);
  }

  function flap(){
    if (gameState==="home"){ startPlaying(); return; }
    if (gameState==="gameover"){ resetGame(true); return; }
    if (gameState==="paused"||gameState==="store") return;
    bird.vy = FLAP;
    // ensure music
    playMusicForMode(musicMode);
  }

  function togglePause(){
    if (gameState==="playing"){
      gameState="paused";
      pauseBtn.textContent="‚ñ∂";
      bgm.pause();
    } else if (gameState==="paused"){
      gameState="playing";
      pauseBtn.textContent="II";
      playMusicForMode(musicMode);
    }
  }

  function toggleMute(){
    muted = !muted;
    if (muted){
      bgm.pause();
      muteBtn.textContent="üîà";
    } else {
      muteBtn.textContent="üîä";
      playMusicForMode(musicMode);
    }
  }

  function pointInRect(px,py,rect){
    return px>=rect.x && px<=rect.x+rect.w && py>=rect.y && py<=rect.y+rect.h;
  }

  function spawnPipe(gap){
    const maxTop = BASE_H - FLOOR_HEIGHT - 100;
    const minTop = 60;
    const topHeight = Math.floor(Math.random()*(maxTop-minTop)+minTop);
    const canMove = score>10 && Math.random()<0.35;
    pipes.push({
      x:BASE_W,
      top:topHeight,
      baseTop:topHeight,
      gap:gap,
      passed:false,
      moving:canMove,
      amp:canMove?(18+Math.random()*18):0,
      phase:Math.random()*Math.PI*2,
      speed:0.0018+Math.random()*0.0013
    });

    // coin in gap
    if (Math.random()<0.45){
      coins.push({
        x:BASE_W+PIPE_WIDTH/2,
        y:topHeight + gap/2,
        r:11,
        t:Math.random()*Math.PI*2,
        collected:false
      });
    }
  }

  function spawnCoinBurst(x,y){
    for (let i=0;i<6;i++){
      particles.push({
        x,y,
        vx:(Math.random()-0.5)*2,
        vy:(Math.random()-1.6)*2,
        life:1,
        c:i%2===0?"rgba(255,220,120,1)":"rgba(255,180,60,1)"
      });
    }
  }

  function die(){
    gameState="gameover";
    saveProgress();
    pauseBtn.textContent="II";
    bgm.pause();
  }

  // STORE
  function getStoreRects(){
    const rects=[];
    const startX=36, startY=110, w=140, h=90, padX=16, padY=14;
    for (let i=0;i<SKINS.length;i++){
      const row = Math.floor(i/2);
      const col = i%2;
      rects.push({
        skin:SKINS[i],
        rect:{ x:startX+col*(w+padX), y:startY+row*(h+padY), w, h }
      });
    }
    return rects;
  }
  function getStoreBackButton(){
    return { x:BASE_W-70, y:60, w:30, h:26 };
  }
  function onStoreSelect(skin){
    if (skin.unlockMeters && maxMetersReached < skin.unlockMeters) return;
    if (!ownedSkins[skin.id]){
      if (totalCoins>=skin.price){
        totalCoins -= skin.price;
        ownedSkins[skin.id] = true;
        activeSkin = skin.id;
        saveProgress();
      } else return;
    } else {
      activeSkin = skin.id;
      saveProgress();
    }

    if (activeSkin==="fish") { musicMode="sea"; initSea(); }
    else if (activeSkin==="dino") { musicMode="jurassic"; initJurassic(); }
    else { musicMode="sky"; initClouds(); }

    playMusicForMode(musicMode);
  }

  // UPDATE
  function update(dt, now){
    // particles
    for (let p of particles){
      p.x+=p.vx;
      p.y+=p.vy;
      p.life-=0.04;
      p.vy+=0.02;
    }
    particles = particles.filter(p=>p.life>0);

    if (gameState==="home" || gameState==="store"){
      if (activeSkin==="fish") moveBubbles();
      else if (activeSkin==="dino") moveJurassic();
      else moveClouds();
      if (gameState==="home"){
        bird.y = BASE_H/2 + Math.sin(now*0.004)*8;
      }
      return;
    }

    if (gameState==="paused" || gameState==="gameover"){
      if (activeSkin==="fish") moveBubbles();
      else if (activeSkin==="dino") moveJurassic();
      else moveClouds();
      return;
    }

    // playing
    const diff = getDifficulty(score);

    bird.vy += GRAVITY;
    bird.y += bird.vy;
    bird.anim += dt*0.01;

    if (now - lastPipeTime > PIPE_INTERVAL){
      spawnPipe(diff.gap);
      lastPipeTime = now;
    }

    // move pipes
    for (let p of pipes){
      p.x -= diff.speed;
      if (p.moving){
        p.top = p.baseTop + Math.sin(now*p.speed + p.phase)*p.amp;
        const maxTop = BASE_H - FLOOR_HEIGHT - 100;
        const minTop = 40;
        if (p.top>maxTop) p.top=maxTop;
        if (p.top<minTop) p.top=minTop;
      }
    }
    pipes = pipes.filter(p=>p.x+PIPE_WIDTH>-10);

    // move coins
    for (let c of coins){
      c.x -= diff.speed;
      c.t += dt*0.008;
    }
    coins = coins.filter(c=>!c.collected && c.x + c.r > -10);

    if (activeSkin==="fish") moveBubbles();
    else if (activeSkin==="dino") moveJurassic();
    else moveClouds();

    groundOffset -= diff.speed;
    if (groundOffset <= -72) groundOffset=0;

    const bx = bird.x, by = bird.y, hitR = bird.r*HITBOX_SHRINK;

    // coin collision
    for (let c of coins){
      const dx = bx - c.x;
      const dy = by - c.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < hitR + c.r*0.85){
        c.collected = true;
        totalCoins += 1;
        spawnCoinBurst(c.x, c.y);
        saveProgress();
      }
    }

    // pipes collision + scoring
    for (let p of pipes){
      const inX = bx + hitR > p.x && bx - hitR < p.x + PIPE_WIDTH;
      const gapTop = p.top;
      const gapBottom = p.top + p.gap;
      if (inX){
        const pad = 4;
        if (by - hitR < gapTop - pad || by + hitR > gapBottom + pad){
          die();
        }
      }
      if (!p.passed && p.x + PIPE_WIDTH < bx){
        p.passed = true;
        score++;
        if (score>best) best = score;

        const metersNow = Math.floor(score/2)*100;
        if (metersNow > maxMetersReached){
          maxMetersReached = metersNow;
          saveProgress();
        }
      }
    }

    if (by + hitR > BASE_H - FLOOR_HEIGHT || by - hitR < 0){
      die();
    }
  }

  // BACKGROUND MOVEMENT
  function moveClouds(){
    for (let c of bgClouds){
      c.x -= c.s;
      if (c.x + c.w < -10){
        c.x = BASE_W + 30;
        c.y = Math.random()*160+20;
      }
    }
  }
  function moveBubbles(){
    for (let b of bubbles){
      b.y -= b.s*2;
      if (b.y < -10){
        b.y = BASE_H+20;
        b.x = Math.random()*BASE_W;
      }
    }
    for (let sc of seaCreatures){
      sc.x += sc.s * sc.dir;
      if (sc.dir>0 && sc.x - sc.w > BASE_W+20){
        sc.x = -30;
        sc.y = 120 + Math.random()*250;
      }
      if (sc.dir<0 && sc.x + sc.w < -20){
        sc.x = BASE_W + 30;
        sc.y = 120 + Math.random()*250;
      }
    }
  }
  function moveJurassic(){
    for (let s of smokePlumes){
      s.y -= s.v;
      s.a -= 0.0025;
      if (s.a <= 0.05){
        s.y = 190 + Math.random()*20;
        s.a = 0.6;
        s.r = 10 + Math.random()*6;
      }
    }
    for (let d of bgDinos){
      d.x += d.s * d.dir;
      if (d.dir>0 && d.x - 30 > BASE_W+10){
        d.x = -30;
        d.y = BASE_H - FLOOR_HEIGHT - 28 - Math.random()*30;
      }
      if (d.dir<0 && d.x + 30 < -10){
        d.x = BASE_W + 20;
        d.y = BASE_H - FLOOR_HEIGHT - 28 - Math.random()*30;
      }
    }
  }

  // DRAW
  function drawBackground(){
    if (activeSkin==="fish" && imgSeaBg.complete && imgSeaBg.naturalWidth){
      ctx.drawImage(imgSeaBg,0,0,BASE_W,BASE_H);
      // overlay slight teal
      ctx.fillStyle="rgba(6,95,133,0.35)";
      ctx.fillRect(0,0,BASE_W,BASE_H);
      // bubbles/creatures drawn separately
    } else if (activeSkin==="dino" && imgDinoBg.complete && imgDinoBg.naturalWidth){
      ctx.drawImage(imgDinoBg,0,0,BASE_W,BASE_H);
      ctx.fillStyle="rgba(68,23,7,0.35)";
      ctx.fillRect(0,0,BASE_W,BASE_H);
      // smoke/dinos drawn separately
    } else if (imgSkyBg.complete && imgSkyBg.naturalWidth){
      ctx.drawImage(imgSkyBg,0,0,BASE_W,BASE_H);
      ctx.fillStyle="rgba(15,23,42,0.08)";
      ctx.fillRect(0,0,BASE_W,BASE_H);
      // clouds
      for (let c of bgClouds){
        ctx.fillStyle="rgba(255,255,255,0.6)";
        ctx.beginPath();
        ctx.roundRect(c.x, c.y, c.w, c.h, 12);
        ctx.fill();
      }
    } else {
      // fallback gradient
      const grad = ctx.createLinearGradient(0,0,0,BASE_H);
      grad.addColorStop(0,"#93c5fd");
      grad.addColorStop(1,"#eef2ff");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,BASE_W,BASE_H);
    }

    // extra env
    if (activeSkin==="fish"){
      for (let sc of seaCreatures){
        ctx.fillStyle=sc.col;
        ctx.beginPath();
        ctx.ellipse(sc.x, sc.y, sc.w, sc.h, 0,0,Math.PI*2);
        ctx.fill();
      }
      for (let b of bubbles){
        ctx.fillStyle="rgba(236,252,203,0.4)";
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
        ctx.fill();
      }
    }
    if (activeSkin==="dino"){
      // volcano smoke plumes
      for (let s of smokePlumes){
        ctx.fillStyle=`rgba(226,232,240,${s.a})`;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }
      // background dinos
      for (let d of bgDinos){
        ctx.fillStyle=d.col;
        ctx.beginPath();
        ctx.ellipse(d.x, d.y, 28, 14, 0, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }

  function drawPipes(){
    if (activeSkin==="fish"){
      for (let p of pipes){
        if (imgCoralPipe.src && imgCoralPipe.complete && imgCoralPipe.naturalWidth){
          // image pipe
          ctx.drawImage(imgCoralPipe, p.x, p.top - imgCoralPipe.height, PIPE_WIDTH, imgCoralPipe.height);
          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.drawImage(imgCoralPipe, p.x, p.top+p.gap, PIPE_WIDTH, bottomH+20);
        } else {
          // vector coral
          const g = ctx.createLinearGradient(p.x,0,p.x+PIPE_WIDTH,0);
          g.addColorStop(0,"rgba(13,148,136,0.95)");
          g.addColorStop(1,"rgba(22,101,114,0.82)");
          ctx.fillStyle=g;
          ctx.fillRect(p.x,0,PIPE_WIDTH,p.top);
          ctx.fillStyle="rgba(226,232,240,0.6)";
          ctx.fillRect(p.x-3,p.top-10,PIPE_WIDTH+6,10);
          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.fillStyle=g;
          ctx.fillRect(p.x,p.top+p.gap,PIPE_WIDTH,bottomH);
          ctx.fillStyle="rgba(226,232,240,0.6)";
          ctx.fillRect(p.x-3,p.top+p.gap,PIPE_WIDTH+6,10);
        }
      }
    } else if (activeSkin==="dino"){
      for (let p of pipes){
        if (imgBonePipe.src && imgBonePipe.complete && imgBonePipe.naturalWidth){
          ctx.drawImage(imgBonePipe, p.x, p.top - imgBonePipe.height, PIPE_WIDTH, imgBonePipe.height);
          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.drawImage(imgBonePipe, p.x, p.top+p.gap, PIPE_WIDTH, bottomH + 20);
        } else {
          // vector bones
          const boneCol = "rgba(248,250,252,0.92)";
          const boneEdge = "rgba(148,163,184,0.6)";
          ctx.fillStyle = boneCol;
          ctx.fillRect(p.x+10,0,PIPE_WIDTH-20,p.top-12);
          ctx.beginPath();
          ctx.fillStyle=boneCol;
          ctx.roundRect(p.x-2,p.top-22,PIPE_WIDTH+4,22,10);
          ctx.fill();
          ctx.strokeStyle=boneEdge;
          ctx.stroke();

          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.fillStyle=boneCol;
          ctx.fillRect(p.x+10,p.top+p.gap+12,PIPE_WIDTH-20,bottomH-12);
          ctx.beginPath();
          ctx.fillStyle=boneCol;
          ctx.roundRect(p.x-2,p.top+p.gap,PIPE_WIDTH+4,22,10);
          ctx.fill();
          ctx.strokeStyle=boneEdge;
          ctx.stroke();
        }
      }
    } else {
      for (let p of pipes){
        if (imgPipe.src && imgPipe.complete && imgPipe.naturalWidth){
          ctx.drawImage(imgPipe, p.x, p.top - imgPipe.height, PIPE_WIDTH, imgPipe.height);
          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.drawImage(imgPipe, p.x, p.top+p.gap, PIPE_WIDTH, bottomH+20);
        } else {
          const grad = ctx.createLinearGradient(p.x,0,p.x+PIPE_WIDTH,0);
          grad.addColorStop(0,"#22c55e");
          grad.addColorStop(1,"#15803d");
          ctx.fillStyle=grad;
          ctx.fillRect(p.x,0,PIPE_WIDTH,p.top);
          ctx.fillStyle="rgba(216,248,208,0.9)";
          ctx.fillRect(p.x-3,p.top-16,PIPE_WIDTH+6,16);
          const bottomH = BASE_H - FLOOR_HEIGHT - (p.top+p.gap);
          ctx.fillStyle=grad;
          ctx.fillRect(p.x,p.top+p.gap,PIPE_WIDTH,bottomH);
          ctx.fillStyle="rgba(216,248,208,0.9)";
          ctx.fillRect(p.x-3,p.top+p.gap,PIPE_WIDTH+6,16);
        }
      }
    }
  }

  function drawGround(){
    if (activeSkin==="fish"){
      ctx.fillStyle="#0f3f39";
      ctx.fillRect(0,BASE_H-FLOOR_HEIGHT,BASE_W,FLOOR_HEIGHT);
      ctx.fillStyle="#155e75";
      ctx.fillRect(0,BASE_H-FLOOR_HEIGHT,BASE_W,10);
    } else if (activeSkin==="dino"){
      ctx.fillStyle="#451a03";
      ctx.fillRect(0,BASE_H-FLOOR_HEIGHT,BASE_W,FLOOR_HEIGHT);
    } else {
      ctx.fillStyle="#a16207";
      ctx.fillRect(0,BASE_H-FLOOR_HEIGHT,BASE_W,FLOOR_HEIGHT);
      ctx.fillStyle="#65a30d";
      ctx.fillRect(0,BASE_H-FLOOR_HEIGHT,BASE_W,14);
      for (let x=groundOffset;x<BASE_W+72;x+=72){
        ctx.fillStyle="rgba(0,0,0,0.08)";
        ctx.fillRect(x,BASE_H-FLOOR_HEIGHT+16,48,14);
      }
    }
  }

  function drawCharacterImageOrVector(imgDrawer){
    // try image for current skin
    let img = null;
    if (activeSkin==="bird" && imgBird.naturalWidth) img = imgBird;
    if (activeSkin==="fish" && imgFish.naturalWidth) img = imgFish;
    if (activeSkin==="dino" && imgDino.naturalWidth) img = imgDino;
    if (activeSkin==="plane" && imgPlane.naturalWidth) img = imgPlane;
    if (activeSkin==="ghost" && imgGhost.naturalWidth) img = imgGhost;
    if (activeSkin==="skeleton" && imgSkeleton.naturalWidth) img = imgSkeleton;
    if (img){
      ctx.drawImage(img, -22, -22, 44, 44);
    } else {
      imgDrawer();
    }
  }

  // vector characters from previous version (kept)
  function drawSkinBird(){ /* simplified but smooth */ 
    const g = ctx.createLinearGradient(-16,-16,16,16);
    g.addColorStop(0,"#ffe28a");
    g.addColorStop(1,"#ff9447");
    ctx.fillStyle=g;
    ctx.beginPath();
    ctx.ellipse(0,0,20,16,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(9,-6,5,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#000";
    ctx.beginPath();
    ctx.arc(11,-6,2.3,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#ffb347";
    ctx.beginPath();
    ctx.moveTo(18,-2); ctx.lineTo(33,2); ctx.lineTo(18,6); ctx.closePath();
    ctx.fill();
  }
  function drawSkinDino(){
    ctx.fillStyle="#f97316";
    ctx.beginPath();
    ctx.ellipse(0,0,18,12,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="rgba(248,250,252,0.08)";
    ctx.beginPath();
    ctx.moveTo(-2,0); ctx.lineTo(-36,-16); ctx.lineTo(-30,10); ctx.closePath();
    ctx.fill();
    ctx.fillStyle="#f97316";
    ctx.beginPath();
    ctx.moveTo(6,-1); ctx.lineTo(28,1); ctx.lineTo(6,4); ctx.closePath();
    ctx.fill();
    ctx.fillStyle="#0f172a";
    ctx.beginPath();
    ctx.arc(6,-3,1.4,0,Math.PI*2);
    ctx.fill();
  }
  function drawSkinFish(){
    ctx.fillStyle="#0ea5e9";
    ctx.beginPath();
    ctx.ellipse(0,0,19,13,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.arc(9,-2,3.4,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle="#0f172a";
    ctx.beginPath();
    ctx.arc(10,-2,1.6,0,Math.PI*2);
    ctx.fill();
  }
  function drawSkinPlane(){
    ctx.fillStyle="#e2e8f0";
    ctx.beginPath();
    ctx.roundRect(-24,-6,48,12,6);
    ctx.fill();
    ctx.fillStyle="#38bdf8";
    ctx.beginPath();
    ctx.roundRect(16,-6,14,12,6);
    ctx.fill();
  }
  function drawSkinGhost(){
    ctx.fillStyle="#fff";
    ctx.beginPath();
    ctx.ellipse(0,0,15,17,0,0,Math.PI*2);
    ctx.fill();
  }
  function drawSkinSkeleton(){
    ctx.fillStyle="#f3f4f6";
    ctx.beginPath();
    ctx.ellipse(0,0,19,16,0,0,Math.PI*2);
    ctx.fill();
  }

  function drawBird(){
    ctx.save();
    ctx.translate(bird.x, bird.y);
    const tilt = (gameState==="home"||gameState==="store") ? Math.sin(performance.now()*0.004)*0.15 :
                  Math.min(Math.max(bird.vy/10, -0.45), 0.6);
    ctx.rotate(tilt);

    drawCharacterImageOrVector(()=>{
      if (activeSkin==="bird") drawSkinBird();
      else if (activeSkin==="fish") drawSkinFish();
      else if (activeSkin==="dino") drawSkinDino();
      else if (activeSkin==="plane") drawSkinPlane();
      else if (activeSkin==="ghost") drawSkinGhost();
      else if (activeSkin==="skeleton") drawSkinSkeleton();
      else drawSkinBird();
    });

    ctx.restore();
  }

  function drawCoins(){
    for (let c of coins){
      const spin = (Math.sin(c.t*3)*0.35)+1;
      const rX = c.r*spin;
      ctx.fillStyle="#facc15";
      ctx.beginPath();
      ctx.ellipse(c.x, c.y, rX, c.r, 0, 0, Math.PI*2);
      ctx.fill();
    }
  }

  function drawParticles(){
    for (let p of particles){
      ctx.globalAlpha = p.life;
      ctx.fillStyle = p.c;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 3*p.life, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  function drawMeters(){
    const metersNow = Math.floor(score/2)*100;
    ctx.fillStyle="rgba(0,0,0,0.45)";
    ctx.beginPath();
    ctx.roundRect(BASE_W/2 - 80, 66, 160, 32, 14);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="13px system-ui, sans-serif";
    ctx.textAlign="center";
    ctx.fillText(metersNow+" m", BASE_W/2, 87);
    ctx.textAlign="left";
  }

  function drawHUD(){
    ctx.fillStyle="rgba(0,0,0,0.35)";
    ctx.beginPath();
    ctx.roundRect(10,10,150,54,10);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="bold 26px system-ui, sans-serif";
    ctx.fillText(score+"",20,42);
    ctx.font="12px system-ui, sans-serif";
    ctx.fillText("Coins: "+totalCoins, 80, 28);
    ctx.fillText("Best: "+best, 80, 44);
  }

  function drawHomeScreen(){
    ctx.fillStyle="rgba(2,6,23,0.35)";
    ctx.beginPath();
    ctx.roundRect(40,110,BASE_W-80,290,22);
    ctx.fill();

    ctx.fillStyle="#fff";
    ctx.font="bold 30px system-ui, sans-serif";
    ctx.fillText("FLAPPY+", 112, 150);
    ctx.font="12px system-ui, sans-serif";
    ctx.fillText("coins: "+totalCoins, 115, 174);
    ctx.fillText("best: "+best, 115, 190);
    ctx.fillText("max m: "+maxMetersReached, 115, 206);

    const pb = homeButtons.play;
    const grad = ctx.createLinearGradient(pb.x, pb.y, pb.x+pb.w, pb.y+pb.h);
    grad.addColorStop(0,"#38bdf8");
    grad.addColorStop(1,"#0ea5e9");
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.roundRect(pb.x, pb.y, pb.w, pb.h, 16);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="15px system-ui, sans-serif";
    ctx.fillText("PLAY", pb.x+68, pb.y+30);

    const sb=homeButtons.store;
    ctx.fillStyle="rgba(15,23,42,0.55)";
    ctx.beginPath();
    ctx.roundRect(sb.x,sb.y,sb.w,sb.h,14);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="12px system-ui, sans-serif";
    ctx.fillText("üõí Store", sb.x+14, sb.y+24);
  }

  function drawStore(){
    ctx.fillStyle="rgba(15,23,42,0.6)";
    ctx.beginPath();
    ctx.roundRect(20,55,BASE_W-40,BASE_H-110,22);
    ctx.fill();

    ctx.fillStyle="#fff";
    ctx.font="bold 20px system-ui, sans-serif";
    ctx.fillText("STORE", 130, 82);

    const backBtn = getStoreBackButton();
    ctx.fillStyle="rgba(15,23,42,0.78)";
    ctx.beginPath();
    ctx.roundRect(backBtn.x, backBtn.y, backBtn.w, backBtn.h, 6);
    ctx.fill();
    ctx.fillStyle="#fff";
    ctx.font="14px system-ui, sans-serif";
    ctx.fillText("‚Üê", backBtn.x+7, backBtn.y+18);

    ctx.font="12px system-ui, sans-serif";
    ctx.fillStyle="rgba(255,255,255,0.7)";
    ctx.fillText("Coins: "+totalCoins, 24, 100);
    ctx.fillText("Max meters: "+maxMetersReached, 170, 100);

    const storeRects = getStoreRects();
    for (const s of storeRects){
      const {x,y,w,h} = s.rect;
      const skin = s.skin;
      const owned = !!ownedSkins[skin.id];
      const locked = skin.unlockMeters && maxMetersReached < skin.unlockMeters;

      ctx.fillStyle = owned ? "rgba(148,163,184,0.2)" : "rgba(15,23,42,0.35)";
      ctx.beginPath();
      ctx.roundRect(x,y,w,h,14);
      ctx.fill();

      // preview
      ctx.save();
      ctx.translate(x+30,y+36);
      const prevSkin = activeSkin;
      const prevBird = bird;
      activeSkin = skin.id;
      bird = { x:0,y:0,anim:performance.now()*0.0001 };
      drawBird();
      bird = prevBird;
      activeSkin = prevSkin;
      ctx.restore();

      ctx.fillStyle="#fff";
      ctx.font="13px system-ui, sans-serif";
      ctx.fillText(skin.name, x+60, y+26);

      ctx.font="11px system-ui, sans-serif";
      if (skin.id==="plane"){
        ctx.fillStyle = locked ? "rgba(248,113,113,0.9)" : "rgba(190,242,100,0.9)";
        ctx.fillText("Unlock: "+skin.unlockMeters+"m", x+60, y+44);
      } else if (skin.price>0){
        ctx.fillStyle = owned ? "rgba(190,242,100,0.9)" : "rgba(248,250,252,0.8)";
        ctx.fillText("Price: "+skin.price+" coins", x+60, y+44);
      } else {
        ctx.fillStyle="rgba(190,242,100,0.9)";
        ctx.fillText("Free", x+60, y+44);
      }

      ctx.fillStyle = owned ? "rgba(34,197,94,1)" : (locked?"rgba(248,113,113,0.9)":"rgba(59,130,246,0.9)");
      ctx.beginPath();
      ctx.roundRect(x+60, y+56, 60, 20, 8);
      ctx.fill();
      ctx.fillStyle="#fff";
      ctx.font="10px system-ui, sans-serif";
      ctx.fillText(owned?"Use":(locked?"Locked":"Buy"), x+74, y+70);
    }
  }

  function drawGameOver(){
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,BASE_W,BASE_H);

    const cardW=260, cardH=200;
    const cx=(BASE_W-cardW)/2;
    const cy=(BASE_H-cardH)/2;
    ctx.fillStyle="rgba(255,255,255,0.98)";
    ctx.beginPath();
    ctx.roundRect(cx,cy,cardW,cardH,16);
    ctx.fill();

    ctx.fillStyle="#0f172a";
    ctx.font="bold 26px system-ui, sans-serif";
    ctx.fillText("GAME OVER", cx+42, cy+42);

    ctx.fillStyle="#334155";
    ctx.font="14px system-ui, sans-serif";
    ctx.fillText("Score: "+score, cx+30, cy+78);
    ctx.fillText("Best: "+best, cx+30, cy+100);
    ctx.fillText("Coins: "+totalCoins, cx+30, cy+122);
    ctx.fillText("Max m: "+maxMetersReached, cx+30, cy+144);
  }

  // LOOP
  let last = performance.now();
  function loop(now){
    const dt = now - last;
    last = now;
    update(dt, now);

    ctx.clearRect(0,0,BASE_W,BASE_H);
    drawBackground();
    drawPipes();
    drawGround();
    drawCoins();
    drawParticles();
    drawBird();

    if (gameState==="home"){
      drawHomeScreen();
      drawMeters();
    } else if (gameState==="playing"){
      drawHUD();
      drawMeters();
    } else if (gameState==="paused"){
      drawHUD();
      drawMeters();
      ctx.fillStyle="rgba(0,0,0,0.4)";
      ctx.fillRect(0,0,BASE_W,BASE_H);
      ctx.fillStyle="#fff";
      ctx.font="bold 32px system-ui, sans-serif";
      ctx.fillText("PAUSED", 108, BASE_H/2);
    } else if (gameState==="gameover"){
      drawHUD();
      drawMeters();
      drawGameOver();
    } else if (gameState==="store"){
      drawStore();
    }

    requestAnimationFrame(loop);
  }

  resetGame(true);
  requestAnimationFrame(loop);

  </script>
</body>
</html>
